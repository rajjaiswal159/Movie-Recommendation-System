<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üìö BookBazar ‚Äî Top Books + Recommendations</title>
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 0;
      color: #3e2723;
    }
    header {
      background: #3e2723;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .project-name { font-size: 20px; font-weight: bold; color: #ff7043; }
    .search-area { display:flex; gap:8px; align-items:center; }
    input[type="text"] {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #8d6e63;
      background: #fff;
      color: #3e2723;
      font-size: 14px;
      outline: none;
      width: 320px;
    }
    .search-btn {
      padding: 8px 14px;
      border-radius: 6px;
      border: none;
      background: linear-gradient(45deg,#ff7043,#ff8a65);
      color: #fff;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
    }
    h1 { text-align:center; margin:20px 0; color:#6d4c41; font-size:36px; }
    .section-title { font-size:25px; margin: 12px 20px; color:#4e342e; }
    .book-container { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:28px; padding: 20px; max-width:1300px; margin: auto; }
    .book-card {
      background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08);
      overflow:hidden; display:flex; flex-direction:column; height:440px; width:240px; padding:6px;
      transition:transform .18s ease, box-shadow .25s ease;
    }
    .book-card:hover { transform:translateY(-6px); box-shadow:0 10px 26px rgba(0,0,0,0.12); }
    .book-card img { width:100%; height:250px; object-fit:cover; }
    .book-details { padding:10px 12px; flex:1; display:flex; flex-direction:column; justify-content:space-between; }
    .book-title { font-size:16px; font-weight:700; text-align:center; margin:0 0 6px; color:#3e2723; }
    .book-info { font-size:14px; margin:2px 0; color:#6d4c41; text-align:left; }
    .book-rating { color:#ff8a65; font-weight:700; }
    .row { max-width:1300px; margin:auto; padding: 6px 20px 0 20px; }
    .small-msg { text-align:center; color:gray; padding:24px 0; }
    .two-sections { display:flex; flex-direction:column; gap:30px; }
  </style>
</head>
<body>
  <header>
    <div class="project-name">üìö BookBazar</div>
    <div class="search-area">
      <input id="searchInput" type="text" placeholder="Search books by title or author..." />
      <button id="searchBtn" class="search-btn">Search</button>
    </div>
  </header>

  <h1>üåü Top Books</h1>

  <div id="topBooksSection">
    <div class="section-title"></div>
    <div class="book-container" id="bookContainer">
      <p class="small-msg">Loading books...</p>
    </div>
  </div>

  <div class="row two-sections">
    <div id="searchResultsSection" style="display:none;">
      <div class="section-title">Search Results</div>
      <div class="book-container" id="searchResults"></div>
    </div>

    <div id="recommendSection" style="display:none;">
      <div class="section-title">Recommended Books</div>
      <div class="book-container" id="recommendations"></div>
    </div>
  </div>

  <script>
    const API_BASE = "http://127.0.0.1:8000/api/books";

    async function fetchTopBooks() {
      try {
        const res = await fetch(API_BASE);
        const books = await res.json();
        renderCards("bookContainer", books);
      } catch (err) {
        document.getElementById("bookContainer").innerHTML = "<p style='color:red; text-align:center;'>Failed to load top books.</p>";
      }
    }

    function renderCards(containerId, books) {
      const container = document.getElementById(containerId);
      container.innerHTML = "";
      if (!books || books.length === 0) {
        container.innerHTML = `<p class="small-msg">No books to show.</p>`;
        return;
      }

      books.forEach(book => {
        const card = document.createElement("div");
        card.className = "book-card";
        const price = `‚Çπ${[199,249,299,349,559,699,749][Math.floor(Math.random()*7)]}`;

        card.innerHTML = `
          <img src="${book.image_url || 'https://via.placeholder.com/240x250?text=No+Image'}" alt="${escapeHtml(book.title)}">
          <div class="book-details">
            <div>
              <p class="book-title">${escapeHtml(book.title)}</p>
              <p class="book-info"><strong>Author:</strong> ${escapeHtml(book.author)}</p>
              <p class="book-info"><strong>Year:</strong> ${escapeHtml(book.year)}</p>
            </div>
            <div>
              <p class="book-info"><strong>Rating:</strong> <span class="book-rating">‚≠ê ${book.average_rating}</span></p>
              <p class="book-info"><strong>Price:</strong> <span class="book-price">${price}</span></p>
            </div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    // escape HTML to avoid injection
    function escapeHtml(text) {
      if (text === undefined || text === null) return "";
      return text.toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    async function doSearch(query) {
      const searchResultsSection = document.getElementById("searchResultsSection");
      const recommendSection = document.getElementById("recommendSection");
      const searchResultsContainer = document.getElementById("searchResults");
      const recommendContainer = document.getElementById("recommendations");

      // clear previous
      searchResultsContainer.innerHTML = "";
      recommendContainer.innerHTML = "";
      searchResultsSection.style.display = "none";
      recommendSection.style.display = "none";

      if (!query) {
        // If empty query, collapse sections and show top books
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/search?query=${encodeURIComponent(query)}`);
        const data = await res.json();

        if (data.message) {
          searchResultsContainer.innerHTML = `<p class="small-msg">${data.message}</p>`;
          searchResultsSection.style.display = "block";
          // optionally show top-rated recommendations instead
          await showFallbackRecommendations();
          return;
        }

        // show search results
        renderCards("searchResults", data);
        searchResultsSection.style.display = "block";

        // request recommendations based on first result's title
        const firstTitle = data[0].title;
        const recRes = await fetch(`${API_BASE}/recommend?title=${encodeURIComponent(firstTitle)}&n=10`);
        const recData = await recRes.json();

        if (recData.message) {
          // no recs found
          recommendContainer.innerHTML = `<p class="small-msg">${recData.message}</p>`;
        } else {
          renderCards("recommendations", recData);
        }
        recommendSection.style.display = "block";
        // scroll to results nicely
        window.scrollTo({ top: document.getElementById("searchResultsSection").offsetTop - 20, behavior: "smooth" });

      } catch (err) {
        searchResultsContainer.innerHTML = `<p class="small-msg" style="color:red;">Failed to search. Check backend is running.</p>`;
        searchResultsSection.style.display = "block";
      }
    }

    async function showFallbackRecommendations() {
      // If search yields nothing, show top 6 rated books from top30
      try {
        const res = await fetch(API_BASE);
        const top = await res.json();
        // pick 6 highest rated
        top.sort((a,b) => (b.average_rating || 0) - (a.average_rating || 0));
        const top6 = top.slice(0,6);
        renderCards("recommendations", top6);
        document.getElementById("recommendSection").style.display = "block";
      } catch (e) {
        // ignore
      }
    }

    // Attach search events
    document.getElementById("searchBtn").addEventListener("click", () => {
      const q = document.getElementById("searchInput").value.trim();
      doSearch(q);
    });
    // also allow Enter key
    document.getElementById("searchInput").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        doSearch(e.target.value.trim());
      }
    });

    // Initial load
    fetchTopBooks();
  </script>
</body>
</html>
